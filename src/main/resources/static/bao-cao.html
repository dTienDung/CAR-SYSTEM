<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            flex: 1 1 250px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .btn-primary {
            background-color: #4caf50;
            color: white;
        }
        .mt-20 {
            margin-top: 20px;
        }
        .report-summary, .report-detail {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .styled-table th, .styled-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .styled-table th {
            background-color: #4caf50;
            color: white;
        }
        canvas {
            max-width: 600px;
            margin: 20px auto;
            display: block;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="nav-brand">üöó H·ªá th·ªëng B·∫£o hi·ªÉm Xe</div>
    <div class="nav-menu">
        <a href="/dashboard.html" class="nav-link">Dashboard</a>
        <a href="/users.html" class="nav-link">Ng∆∞·ªùi d√πng</a>
        <a href="/khach-hang.html" class="nav-link">Kh√°ch h√†ng</a>
        <a href="/xe.html" class="nav-link">Xe</a>
        <a href="/goi-bao-hiem.html" class="nav-link">G√≥i BH</a>
        <a href="/ho-so-tham-dinh.html" class="nav-link">H·ªì s∆° TD</a>
        <a href="/hop-dong.html" class="nav-link">H·ª£p ƒë·ªìng</a>
        <a href="/thanh-toan.html" class="nav-link">Thanh to√°n</a>
        <a href="/bao-cao.html" class="nav-link active">B√°o c√°o</a>
        <button class="btn btn-sm" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
</nav>

<div class="container">
    <h1>üìä B√°o c√°o</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>B√°o c√°o Doanh thu</h3>
            <button class="btn btn-primary mt-20" onclick="loadBaoCao('doanh-thu')">Xem b√°o c√°o</button>
        </div>
        <div class="stat-card">
            <h3>B√°o c√°o T√°i t·ª•c</h3>
            <button class="btn btn-primary mt-20" onclick="loadBaoCao('tai-tuc')">Xem b√°o c√°o</button>
        </div>
        <div class="stat-card">
            <h3>B√°o c√°o Th·∫©m ƒë·ªãnh</h3>
            <button class="btn btn-primary mt-20" onclick="loadBaoCao('tham-dinh')">Xem b√°o c√°o</button>
        </div>
    </div>

    <div id="baoCaoThongKe" class="report-summary"></div>
    <div id="baoCaoChiTiet" class="report-detail"></div>
    <canvas id="baoCaoChart"></canvas>
</div>
<script>
    let baoCaoChartInstance = null;

    async function loadBaoCao(type) {
        const thongKeDiv = document.getElementById('baoCaoThongKe');
        const chiTietDiv = document.getElementById('baoCaoChiTiet');
        const chartCanvas = document.getElementById('baoCaoChart');

        // Hi·ªÉn th·ªã loading
        thongKeDiv.innerHTML = `
            <div style="text-align:center;padding:40px;color:#667eea;font-size:18px;">
                <div style="display:inline-block;animation:spin 1s linear infinite;">‚è≥</div>
                <div style="margin-top:8px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        `;
        chiTietDiv.innerHTML = '';
        chartCanvas.style.display = 'none';

        // Destroy chart c≈© n·∫øu c√≥
        if (baoCaoChartInstance) {
            baoCaoChartInstance.destroy();
            baoCaoChartInstance = null;
        }

        try {
            const response = await apiGet(`/bao-cao/${type}`);
            const data = response.data;

            thongKeDiv.innerHTML = '';
            chiTietDiv.innerHTML = '';

            if (type === 'doanh-thu') {
                thongKeDiv.innerHTML = `<p><strong>T·ªïng doanh thu:</strong> ${(data.tongDoanhThu || 0).toLocaleString()} VNƒê</p>`;
            } else if (type === 'tai-tuc') {
                thongKeDiv.innerHTML = `<p><strong>S·ªë h·ª£p ƒë·ªìng t√°i t·ª•c:</strong> ${data.soHopDongTaiTuc || 0}</p>`;
            } else if (type === 'tham-dinh' && data.countByStatus) {
                // Helper badges
                function getStatusBadge(status) {
                    const badges = {
                        'Ch·ªù duy·ªát': '<span style="background:#ffc107;color:#000;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚è≥ Ch·ªù duy·ªát</span>',
                        'ƒê√£ duy·ªát': '<span style="background:#4caf50;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚úÖ ƒê√£ duy·ªát</span>',
                        'T·ª´ ch·ªëi': '<span style="background:#f44336;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">‚ùå T·ª´ ch·ªëi</span>',
                        'ƒêang x·ª≠ l√Ω': '<span style="background:#2196f3;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üîÑ ƒêang x·ª≠ l√Ω</span>'
                    };
                    return badges[status] || `<span style="background:#999;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">${status}</span>`;
                }

                function getRiskLevelBadge(level) {
                    const badges = {
                        'Th·∫•p': '<span style="background:#4caf50;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üü¢ Th·∫•p</span>',
                        'Trung b√¨nh': '<span style="background:#ff9800;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üü° Trung b√¨nh</span>',
                        'Cao': '<span style="background:#f44336;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">üî¥ Cao</span>'
                    };
                    return badges[level] || `<span style="background:#999;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;">${level}</span>`;
                }

                // T·∫°o summary card
                const statusColors = {
                    'Ch·ªù duy·ªát': 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',
                    'ƒê√£ duy·ªát': 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)',
                    'T·ª´ ch·ªëi': 'linear-gradient(135deg, #f44336 0%, #e53935 100%)',
                    'ƒêang x·ª≠ l√Ω': 'linear-gradient(135deg, #2196f3 0%, #1976d2 100%)'
                };

                const statusCards = Object.entries(data.countByStatus)
                    .map(([status, count]) => `
                        <div style="background:${statusColors[status] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};padding:20px;border-radius:12px;color:white;text-align:center;">
                            <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">${status}</div>
                            <div style="font-size:28px;font-weight:bold;">${count}</div>
                        </div>
                    `).join('');

                thongKeDiv.innerHTML = `
                    <div style="background:#fff;padding:32px;border-radius:16px;margin-bottom:24px;box-shadow:0 8px 24px rgba(0,0,0,0.15);">
                        <h2 style="color:#667eea;margin-bottom:24px;font-size:24px;border-bottom:3px solid #667eea;padding-bottom:12px;">‚úÖ B√°o c√°o Th·∫©m ƒë·ªãnh</h2>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:0;">
                            ${statusCards}
                            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;border-radius:12px;color:white;text-align:center;">
                                <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">ƒêi·ªÉm TB Risk Score</div>
                                <div style="font-size:28px;font-weight:bold;">${data.avgRiskScore?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div style="background:linear-gradient(135deg, #11998e 0%, #38ef7d 100%);padding:20px;border-radius:12px;color:white;text-align:center;">
                                <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">T·ªïng ph√≠ b·∫£o hi·ªÉm</div>
                                <div style="font-size:20px;font-weight:bold;">${(data.totalPhi || 0).toLocaleString()} VNƒê</div>
                            </div>
                        </div>
                    </div>
                `;

                // T·∫°o HTML cho b·∫£ng chi ti·∫øt - ƒê√ÇY L√Ä PH·∫¶N S·ª¨A L·ªñI
                const tableRows = data.details.map(hs => {
                    const riskLevel = hs.riskLevel || '';
                    const trangThai = hs.trangThai || '';

                    return `
                        <tr>
                            <td>${hs.maHS}</td>
                            <td>${hs.khachHang || '<em style="color:#999;">Ch∆∞a c√≥</em>'}</td>
                            <td><strong style="color:#667eea;">${hs.bienSo || '<em style="color:#999;">N/A</em>'}</strong></td>
                            <td>${hs.goiBaoHiem || '<em style="color:#999;">Ch∆∞a ch·ªçn</em>'}</td>
                            <td>${hs.riskScore || 0}</td>
                            <td>${getRiskLevelBadge(riskLevel)}</td>
                            <td>${getStatusBadge(trangThai)}</td>
                            <td style="font-weight:bold;color:#2e7d32;">${(hs.phiBaoHiem || 0).toLocaleString()} VNƒê</td>
                        </tr>
                    `;
                }).join('');

                chiTietDiv.innerHTML = `
                    <div style="background:#fff;padding:32px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.15);">
                        <h2 style="color:#667eea;margin-bottom:24px;font-size:24px;border-bottom:3px solid #667eea;padding-bottom:12px;">üìã Chi ti·∫øt h·ªì s∆° th·∫©m ƒë·ªãnh</h2>
                        <div style="overflow-x:auto;">
                            <table class="styled-table">
                                <thead>
                                    <tr>
                                        <th>M√£ HS</th>
                                        <th>Kh√°ch h√†ng</th>
                                        <th>Bi·ªÉn s·ªë</th>
                                        <th>G√≥i BH</th>
                                        <th>Risk Score</th>
                                        <th>Risk Level</th>
                                        <th>Tr·∫°ng th√°i</th>
                                        <th>Ph√≠ BH</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // V·∫Ω Doughnut chart
                chartCanvas.style.display = 'block';
                const ctx = chartCanvas.getContext('2d');
                const chartLabels = Object.keys(data.countByStatus);
                const chartData = Object.values(data.countByStatus);
                const chartColors = chartLabels.map(label => {
                    const colorMap = {
                        'Ch·ªù duy·ªát': 'rgba(255, 193, 7, 0.9)',
                        'ƒê√£ duy·ªát': 'rgba(76, 175, 80, 0.9)',
                        'T·ª´ ch·ªëi': 'rgba(244, 67, 54, 0.9)',
                        'ƒêang x·ª≠ l√Ω': 'rgba(33, 150, 243, 0.9)'
                    };
                    return colorMap[label] || 'rgba(102, 126, 234, 0.9)';
                });

                baoCaoChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: chartColors,
                            borderColor: '#fff',
                            borderWidth: 3,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 20, font: { size: 14, weight: '600' }, usePointStyle: true, pointStyle: 'circle' } },
                            title: { display: true, text: 'Ph√¢n b·ªï tr·∫°ng th√°i h·ªì s∆° th·∫©m ƒë·ªãnh', font: { size: 20, weight: 'bold' }, padding: { top: 10, bottom: 30 }, color: '#333' },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                callbacks: {
                                    label: function(ctx) {
                                        const val = ctx.parsed || 0;
                                        const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                                        return `${ctx.label}: ${val} h·ªì s∆° (${((val/total)*100).toFixed(1)}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        } catch(err) {
            thongKeDiv.innerHTML = `<p style="color:red">L·ªói: ${err.message}</p>`;
            chiTietDiv.innerHTML = '';
        }
    }
</script>


    <script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/role.js"></script>
<script src="/js/dashboard.js"></script>
</body>
</html>
